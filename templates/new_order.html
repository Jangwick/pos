{% extends "base.html" %}

{% block title %}New Order{% endblock %}

{% block content %}
<h1 class="text-3xl font-bold mb-6">New Order</h1>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Menu Categories and Products -->
    <div class="lg:col-span-2">
        <div class="bg-white rounded-lg shadow p-6">
            <!-- Order Type Selection -->
            <div class="mb-6">
                <h2 class="text-xl font-bold mb-3">Order Type</h2>
                <div class="flex space-x-4">
                    <label class="inline-flex items-center">
                        <input type="radio" name="orderType" value="dine-in" checked class="form-radio text-red-700">
                        <span class="ml-2">Dine-in</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="orderType" value="take-out" class="form-radio text-red-700">
                        <span class="ml-2">Take-out</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="orderType" value="delivery" class="form-radio text-red-700">
                        <span class="ml-2">Delivery</span>
                    </label>
                </div>
            </div>
            
            <!-- Categories Tabs -->
            <div class="mb-6">
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8">
                        <button class="category-tab py-2 px-1 border-b-2 border-red-700 text-red-700 font-medium" data-category="all">All Items</button>
                        {% for category in categories %}
                            <button class="category-tab py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-category="{{ category.id }}">{{ category.name }}</button>
                        {% endfor %}
                    </nav>
                </div>
            </div>
            
            <!-- Products Grid -->
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4" id="products-grid">
                {% for product in products %}
                    <div class="product-item border rounded-lg overflow-hidden hover:shadow-md cursor-pointer" 
                         data-id="{{ product.id }}" 
                         data-name="{{ product.name }}" 
                         data-price="{{ product.price }}"
                         data-category="{{ product.category_id }}">
                        <div class="h-32 bg-gray-200 relative">
                            <img src="{{ url_for('static', filename='uploads/' + product.image) }}" alt="{{ product.name }}" class="w-full h-full object-cover">
                            {% if not product.available %}
                                <div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center">
                                    <span class="text-white font-bold">Out of Stock</span>
                                </div>
                            {% endif %}
                        </div>
                        <div class="p-2">
                            <h3 class="font-semibold truncate">{{ product.name }}</h3>
                            <p class="text-red-700">₱{{ "{:,.2f}".format(product.price) }}</p>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- Order Summary -->
    <div class="lg:col-span-1">
        <div class="bg-white rounded-lg shadow p-6 sticky top-6">
            <h2 class="text-xl font-bold mb-4">Current Order</h2>
            
            <!-- Order Items -->
            <div class="space-y-3 mb-6 max-h-96 overflow-y-auto" id="order-items">
                <p class="text-gray-500 text-center py-4" id="empty-cart-message">No items added</p>
            </div>
            
            <!-- Order Summary -->
            <div class="border-t pt-4 space-y-2">
                <div class="flex justify-between">
                    <span>Subtotal</span>
                    <span id="subtotal">₱0.00</span>
                </div>
                <div class="flex justify-between">
                    <span>Tax (12%)</span>
                    <span id="tax">₱0.00</span>
                </div>
                <div class="flex justify-between font-bold">
                    <span>Total</span>
                    <span id="total">₱0.00</span>
                </div>
            </div>
            
            <!-- Payment Method -->
            <div class="my-6">
                <label class="block text-gray-700 text-sm font-bold mb-2" for="payment-method">Payment Method</label>
                <select id="payment-method" class="form-select block w-full mt-1 border-gray-300 rounded-md shadow-sm focus:border-red-300 focus:ring focus:ring-red-200 focus:ring-opacity-50">
                    <option value="cash">Cash</option>
                    <option value="card">Credit/Debit Card</option>
                    <option value="gcash">GCash</option>
                    <option value="paymaya">PayMaya</option>
                </select>
            </div>
            
            <!-- Action Buttons -->
            <div class="grid grid-cols-2 gap-4">
                <button id="clear-order" class="bg-gray-300 text-gray-800 py-2 px-4 rounded hover:bg-gray-400">
                    Clear
                </button>
                <button id="place-order" class="bg-red-700 text-white py-2 px-4 rounded hover:bg-red-800 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                    Place Order
                </button>
            </div>
            
            <!-- Additional Options -->
            <div class="mt-6 space-y-3">
                <button class="text-sm text-gray-600 hover:text-red-700 w-full text-left">
                    <i class="fas fa-user-plus mr-2"></i> Add Customer
                </button>
                <button class="text-sm text-gray-600 hover:text-red-700 w-full text-left">
                    <i class="fas fa-receipt mr-2"></i> Apply Promo Code
                </button>
                <button class="text-sm text-gray-600 hover:text-red-700 w-full text-left">
                    <i class="fas fa-qrcode mr-2"></i> Scan Rewards Card
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Item Customization Modal -->
<div id="customize-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold" id="modal-product-name"></h2>
            <button onclick="closeCustomizeModal()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="quantity">
                Quantity
            </label>
            <div class="flex items-center">
                <button id="decrease-quantity" class="bg-gray-200 px-3 py-1 rounded-l">
                    <i class="fas fa-minus"></i>
                </button>
                <input id="quantity" type="number" value="1" min="1" class="w-16 text-center py-1 border-t border-b border-gray-300">
                <button id="increase-quantity" class="bg-gray-200 px-3 py-1 rounded-r">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>
        
        <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="notes">
                Special Instructions
            </label>
            <textarea id="notes" class="w-full px-3 py-2 border rounded-md"></textarea>
        </div>
        
        <div id="modal-addons" class="mb-4">
            <h3 class="font-bold text-sm mb-2">Add-ons</h3>
            <div class="space-y-2">
                <div class="flex items-center justify-between">
                    <label class="inline-flex items-center">
                        <input type="checkbox" class="form-checkbox text-red-700">
                        <span class="ml-2">Extra Rice</span>
                    </label>
                    <span>₱30.00</span>
                </div>
                <div class="flex items-center justify-between">
                    <label class="inline-flex items-center">
                        <input type="checkbox" class="form-checkbox text-red-700">
                        <span class="ml-2">Extra Nori</span>
                    </label>
                    <span>₱20.00</span>
                </div>
            </div>
        </div>
        
        <div class="flex justify-end">
            <button id="add-to-order" class="bg-red-700 text-white py-2 px-4 rounded hover:bg-red-800">
                Add to Order
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentOrder = [];
    let selectedProduct = null;
    
    document.addEventListener('DOMContentLoaded', function() {
        // Category switching
        document.querySelectorAll('.category-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                // Update active tab styling
                document.querySelectorAll('.category-tab').forEach(t => {
                    t.classList.remove('border-red-700', 'text-red-700');
                    t.classList.add('border-transparent', 'text-gray-500');
                });
                this.classList.add('border-red-700', 'text-red-700');
                this.classList.remove('border-transparent', 'text-gray-500');
                
                // Filter products
                const categoryId = this.dataset.category;
                filterProducts(categoryId);
            });
        });
        
        // Product selection
        document.querySelectorAll('.product-item').forEach(item => {
            item.addEventListener('click', function() {
                if (!this.querySelector('.bg-opacity-50')) { // If not out of stock
                    selectedProduct = {
                        id: this.dataset.id,
                        name: this.dataset.name,
                        price: parseFloat(this.dataset.price)
                    };
                    document.getElementById('modal-product-name').textContent = selectedProduct.name;
                    document.getElementById('customize-modal').classList.remove('hidden');
                }
            });
        });
        
        // Quantity controls
        document.getElementById('increase-quantity').addEventListener('click', function() {
            const quantity = document.getElementById('quantity');
            quantity.value = parseInt(quantity.value) + 1;
        });
        
        document.getElementById('decrease-quantity').addEventListener('click', function() {
            const quantity = document.getElementById('quantity');
            if (parseInt(quantity.value) > 1) {
                quantity.value = parseInt(quantity.value) - 1;
            }
        });
        
        // Add to order
        document.getElementById('add-to-order').addEventListener('click', function() {
            if (selectedProduct) {
                const quantity = parseInt(document.getElementById('quantity').value);
                const notes = document.getElementById('notes').value;
                
                currentOrder.push({
                    productId: selectedProduct.id,
                    name: selectedProduct.name,
                    price: selectedProduct.price,
                    quantity: quantity,
                    notes: notes,
                    total: selectedProduct.price * quantity
                });
                
                updateOrderSummary();
                closeCustomizeModal();
            }
        });
        
        // Clear order
        document.getElementById('clear-order').addEventListener('click', function() {
            currentOrder = [];
            updateOrderSummary();
        });
        
        // Place order
        document.getElementById('place-order').addEventListener('click', function() {
            const orderType = document.querySelector('input[name="orderType"]:checked').value;
            const paymentMethod = document.getElementById('payment-method').value;
            
            // Calculate totals
            const subtotal = currentOrder.reduce((sum, item) => sum + item.total, 0);
            const tax = subtotal * 0.12;
            const total = subtotal + tax;
            
            // Prepare order data
            const orderData = {
                orderType: orderType,
                paymentMethod: paymentMethod,
                items: currentOrder.map(item => ({
                    productId: item.productId,
                    quantity: item.quantity,
                    price: item.price,
                    notes: item.notes
                })),
                subtotal: subtotal,
                tax: tax,
                totalAmount: total
            };
            
            // Send order to server
            fetch('/new-order', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(orderData),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Order placed successfully!');
                    currentOrder = [];
                    updateOrderSummary();
                    // Redirect to orders page
                    window.location.href = '/orders';
                } else {
                    alert('Failed to place order');
                }
            })
            .catch(error => {
                alert('An error occurred while placing the order');
            });
        });
    });
    
    function filterProducts(categoryId) {
        const products = document.querySelectorAll('.product-item');
        
        products.forEach(product => {
            if (categoryId === 'all' || product.dataset.category === categoryId) {
                product.classList.remove('hidden');
            } else {
                product.classList.add('hidden');
            }
        });
    }
    
    function closeCustomizeModal() {
        document.getElementById('customize-modal').classList.add('hidden');
        document.getElementById('quantity').value = 1;
        document.getElementById('notes').value = '';
        selectedProduct = null;
    }
    
    function updateOrderSummary() {
        const orderItemsContainer = document.getElementById('order-items');
        const emptyCartMessage = document.getElementById('empty-cart-message');
        const placeOrderButton = document.getElementById('place-order');
        
        if (currentOrder.length === 0) {
            orderItemsContainer.innerHTML = '<p class="text-gray-500 text-center py-4" id="empty-cart-message">No items added</p>';
            placeOrderButton.disabled = true;
        } else {
            let html = '';
            
            currentOrder.forEach((item, index) => {
                html += `
                    <div class="flex justify-between items-start border-b pb-2">
                        <div>
                            <div class="flex items-center">
                                <span class="font-semibold">${item.quantity}x</span>
                                <span class="ml-2">${item.name}</span>
                            </div>
                            <p class="text-sm text-gray-500">${item.notes || 'No special instructions'}</p>
                        </div>
                        <div class="text-right">
                            <p>₱${item.total.toFixed(2)}</p>
                            <button class="text-xs text-red-700" onclick="removeOrderItem(${index})">Remove</button>
                        </div>
                    </div>
                `;
            });
            
            orderItemsContainer.innerHTML = html;
            placeOrderButton.disabled = false;
        }
        
        // Update totals
        const subtotal = currentOrder.reduce((sum, item) => sum + item.total, 0);
        const tax = subtotal * 0.12;
        const total = subtotal + tax;
        
        document.getElementById('subtotal').textContent = `₱${subtotal.toFixed(2)}`;
        document.getElementById('tax').textContent = `₱${tax.toFixed(2)}`;
        document.getElementById('total').textContent = `₱${total.toFixed(2)}`;
    }
    
    function removeOrderItem(index) {
        currentOrder.splice(index, 1);
        updateOrderSummary();
    }
</script>
{% endblock %}
